<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Flow Test - Gursha Guide</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 2.5rem;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 1.1rem;
    }
    .test-section {
      background: #f8f9fa;
      padding: 25px;
      margin: 20px 0;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    .test-section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5rem;
    }
    .status {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
      margin-left: 10px;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      margin: 5px;
      transition: all 0.3s;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .result {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .success-text { color: #28a745; font-weight: bold; }
    .error-text { color: #dc3545; font-weight: bold; }
    .info-text { color: #17a2b8; }
    
    .progress {
      display: flex;
      justify-content: space-between;
      margin: 30px 0;
      position: relative;
    }
    .progress::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 4px;
      background: #e0e0e0;
      z-index: 0;
    }
    .step {
      text-align: center;
      flex: 1;
      position: relative;
      z-index: 1;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .step.active .step-circle {
      background: #667eea;
      transform: scale(1.2);
    }
    .step.completed .step-circle {
      background: #28a745;
    }
    .step-label {
      font-size: 0.85rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Complete Flow Test</h1>
    <p class="subtitle">Test the entire authentication and payment flow</p>

    <!-- Progress Tracker -->
    <div class="progress">
      <div class="step" id="step1">
        <div class="step-circle">1</div>
        <div class="step-label">Firebase</div>
      </div>
      <div class="step" id="step2">
        <div class="step-circle">2</div>
        <div class="step-label">Register</div>
      </div>
      <div class="step" id="step3">
        <div class="step-circle">3</div>
        <div class="step-label">Login</div>
      </div>
      <div class="step" id="step4">
        <div class="step-circle">4</div>
        <div class="step-label">Access</div>
      </div>
      <div class="step" id="step5">
        <div class="step-circle">5</div>
        <div class="step-label">Payment</div>
      </div>
    </div>

    <!-- Test 1: Firebase Connection -->
    <div class="test-section">
      <h2>1Ô∏è‚É£ Firebase Connection <span class="status info" id="status1">Not Tested</span></h2>
      <button onclick="testFirebase()">Test Firebase</button>
      <div id="result1" class="result" style="display:none;"></div>
    </div>

    <!-- Test 2: User Registration -->
    <div class="test-section">
      <h2>2Ô∏è‚É£ User Registration <span class="status info" id="status2">Not Tested</span></h2>
      <input type="text" id="reg-name" placeholder="Name" value="Test User">
      <input type="email" id="reg-email" placeholder="Email" value="test@example.com">
      <input type="password" id="reg-password" placeholder="Password" value="password123">
      <button onclick="testRegister()">Register User</button>
      <div id="result2" class="result" style="display:none;"></div>
    </div>

    <!-- Test 3: User Login -->
    <div class="test-section">
      <h2>3Ô∏è‚É£ User Login <span class="status info" id="status3">Not Tested</span></h2>
      <input type="email" id="login-email" placeholder="Email" value="test@example.com">
      <input type="password" id="login-password" placeholder="Password" value="password123">
      <button onclick="testLogin()">Login User</button>
      <div id="result3" class="result" style="display:none;"></div>
    </div>

    <!-- Test 4: Recipe Access Control -->
    <div class="test-section">
      <h2>4Ô∏è‚É£ Recipe Access Control <span class="status info" id="status4">Not Tested</span></h2>
      <button onclick="testRecipeAccess('free')">Test Free Recipe</button>
      <button onclick="testRecipeAccess('gold')">Test Gold Recipe</button>
      <button onclick="testRecipeAccess('platinum')">Test Platinum Recipe</button>
      <div id="result4" class="result" style="display:none;"></div>
    </div>

    <!-- Test 5: Payment System -->
    <div class="test-section">
      <h2>5Ô∏è‚É£ Payment System <span class="status info" id="status5">Not Tested</span></h2>
      <button onclick="testPaymentSystem()">Test Payment System</button>
      <button onclick="simulatePayment('gold')">Simulate Gold Payment</button>
      <button onclick="simulatePayment('platinum')">Simulate Platinum Payment</button>
      <div id="result5" class="result" style="display:none;"></div>
    </div>

    <!-- Test 6: Subscription Update -->
    <div class="test-section">
      <h2>6Ô∏è‚É£ Subscription Update <span class="status info" id="status6">Not Tested</span></h2>
      <button onclick="testSubscriptionUpdate('gold')">Upgrade to Gold</button>
      <button onclick="testSubscriptionUpdate('platinum')">Upgrade to Platinum</button>
      <button onclick="testSubscriptionUpdate('free')">Downgrade to Free</button>
      <div id="result6" class="result" style="display:none;"></div>
    </div>

    <!-- Test 7: Logout -->
    <div class="test-section">
      <h2>7Ô∏è‚É£ Logout <span class="status info" id="status7">Not Tested</span></h2>
      <button onclick="testLogout()">Logout User</button>
      <div id="result7" class="result" style="display:none;"></div>
    </div>
  </div>

  <script type="module">
    import { authService } from './firebase-config.js';
    
    window.authService = authService;
    
    // Helper functions
    function updateStatus(testNum, status, message) {
      const statusEl = document.getElementById(`status${testNum}`);
      const resultEl = document.getElementById(`result${testNum}`);
      const stepEl = document.getElementById(`step${testNum}`);
      
      statusEl.className = `status ${status}`;
      statusEl.textContent = message;
      
      if (stepEl) {
        stepEl.classList.remove('active');
        if (status === 'success') {
          stepEl.classList.add('completed');
        }
      }
      
      resultEl.style.display = 'block';
    }
    
    function showResult(testNum, content, isError = false) {
      const resultEl = document.getElementById(`result${testNum}`);
      resultEl.innerHTML = content;
      resultEl.style.color = isError ? '#dc3545' : '#333';
    }
    
    // Test 1: Firebase Connection
    window.testFirebase = async function() {
      document.getElementById('step1').classList.add('active');
      try {
        showResult(1, '‚è≥ Testing Firebase connection...');
        
        if (!authService) {
          throw new Error('Auth service not loaded');
        }
        
        const result = `<span class="success-text">‚úÖ Firebase Connected!</span>
        
Auth Service: Available
Methods Available:
  - register()
  - login()
  - logout()
  - getCurrentUser()
  - getUserData()
  - updateSubscription()`;
        
        showResult(1, result);
        updateStatus(1, 'success', 'Connected');
      } catch (error) {
        showResult(1, `<span class="error-text">‚ùå Error: ${error.message}</span>`, true);
        updateStatus(1, 'error', 'Failed');
      }
    };
    
    // Test 2: Registration
    window.testRegister = async function() {
      document.getElementById('step2').classList.add('active');
      const name = document.getElementById('reg-name').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;
      
      try {
        showResult(2, '‚è≥ Registering user...');
        const user = await authService.register(email, password, name);
        
        const result = `<span class="success-text">‚úÖ User Registered!</span>
        
User ID: ${user.uid}
Email: ${user.email}
        
‚úÖ User created in Firebase Auth
‚úÖ User data saved to Firestore
‚úÖ Default subscription: free`;
        
        showResult(2, result);
        updateStatus(2, 'success', 'Registered');
      } catch (error) {
        let errorMsg = error.message;
        if (error.code === 'auth/email-already-in-use') {
          errorMsg = 'Email already registered (This is OK - user exists)';
          updateStatus(2, 'warning', 'Already Exists');
        } else {
          updateStatus(2, 'error', 'Failed');
        }
        showResult(2, `<span class="error-text">‚ùå ${errorMsg}</span>`, true);
      }
    };
    
    // Test 3: Login
    window.testLogin = async function() {
      document.getElementById('step3').classList.add('active');
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        showResult(3, '‚è≥ Logging in...');
        const user = await authService.login(email, password);
        const userData = await authService.getUserData(user.uid);
        
        const result = `<span class="success-text">‚úÖ Login Successful!</span>
        
User ID: ${user.uid}
Email: ${user.email}
Name: ${userData.name}
Subscription: ${userData.subscriptionLevel}
        
‚úÖ User authenticated
‚úÖ User data retrieved from Firestore`;
        
        showResult(3, result);
        updateStatus(3, 'success', 'Logged In');
      } catch (error) {
        showResult(3, `<span class="error-text">‚ùå ${error.message}</span>`, true);
        updateStatus(3, 'error', 'Failed');
      }
    };
    
    // Test 4: Recipe Access
    window.testRecipeAccess = async function(recipeLevel) {
      document.getElementById('step4').classList.add('active');
      try {
        showResult(4, `‚è≥ Testing ${recipeLevel} recipe access...`);
        
        const user = authService.getCurrentUser();
        if (!user) {
          throw new Error('Please login first');
        }
        
        const userData = await authService.getUserData(user.uid);
        const userLevel = userData.subscriptionLevel || 'free';
        
        const levels = { free: 0, gold: 1, platinum: 2 };
        const hasAccess = levels[userLevel] >= levels[recipeLevel];
        
        const result = hasAccess 
          ? `<span class="success-text">‚úÖ Access Granted!</span>

User Level: ${userLevel}
Recipe Level: ${recipeLevel}
Result: Can access this recipe`
          : `<span class="error-text">üîí Access Denied</span>

User Level: ${userLevel}
Recipe Level: ${recipeLevel}
Result: Upgrade required to ${recipeLevel}`;
        
        showResult(4, result);
        updateStatus(4, hasAccess ? 'success' : 'warning', hasAccess ? 'Accessible' : 'Locked');
      } catch (error) {
        showResult(4, `<span class="error-text">‚ùå ${error.message}</span>`, true);
        updateStatus(4, 'error', 'Failed');
      }
    };
    
    // Test 5: Payment System
    window.testPaymentSystem = async function() {
      document.getElementById('step5').classList.add('active');
      try {
        showResult(5, '‚è≥ Testing payment system...');
        
        const user = authService.getCurrentUser();
        if (!user) {
          throw new Error('Please login first');
        }
        
        const result = `<span class="success-text">‚úÖ Payment System Ready!</span>
        
Current User: ${user.email}
Payment Methods Available:
  - Telebirr
  - CBE Bank Transfer
  
Plans Available:
  - Gold: 500 ETB
  - Platinum: 1000 ETB
  
‚úÖ Payment verification API configured
‚úÖ Subscription activation ready`;
        
        showResult(5, result);
        updateStatus(5, 'success', 'Ready');
      } catch (error) {
        showResult(5, `<span class="error-text">‚ùå ${error.message}</span>`, true);
        updateStatus(5, 'error', 'Failed');
      }
    };
    
    // Simulate Payment
    window.simulatePayment = async function(plan) {
      document.getElementById('step5').classList.add('active');
      try {
        showResult(5, `‚è≥ Simulating ${plan} payment...`);
        
        const user = authService.getCurrentUser();
        if (!user) {
          throw new Error('Please login first');
        }
        
        // Simulate payment processing
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Update subscription
        await authService.updateSubscription(user.uid, plan);
        
        const result = `<span class="success-text">‚úÖ Payment Successful!</span>
        
Plan: ${plan.toUpperCase()}
Amount: ${plan === 'gold' ? '500' : '1000'} ETB
        
‚úÖ Payment processed
‚úÖ Subscription activated
‚úÖ Firestore updated`;
        
        showResult(5, result);
        updateStatus(5, 'success', 'Paid');
      } catch (error) {
        showResult(5, `<span class="error-text">‚ùå ${error.message}</span>`, true);
        updateStatus(5, 'error', 'Failed');
      }
    };
    
    // Test 6: Subscription Update
    window.testSubscriptionUpdate = async function(level) {
      document.getElementById('step5').classList.add('active');
      try {
        showResult(6, `‚è≥ Updating subscription to ${level}...`);
        
        const user = authService.getCurrentUser();
        if (!user) {
          throw new Error('Please login first');
        }
        
        await authService.updateSubscription(user.uid, level);
        const userData = await authService.getUserData(user.uid);
        
        const result = `<span class="success-text">‚úÖ Subscription Updated!</span>
        
New Level: ${userData.subscriptionLevel}
Updated: ${new Date().toLocaleString()}
        
‚úÖ Firestore updated
‚úÖ Access level changed`;
        
        showResult(6, result);
        updateStatus(6, 'success', 'Updated');
      } catch (error) {
        showResult(6, `<span class="error-text">‚ùå ${error.message}</span>`, true);
        updateStatus(6, 'error', 'Failed');
      }
    };
    
    // Test 7: Logout
    window.testLogout = async function() {
      document.getElementById('step7').classList.add('active');
      try {
        showResult(7, '‚è≥ Logging out...');
        await authService.logout();
        
        const result = `<span class="success-text">‚úÖ Logged Out!</span>
        
‚úÖ User signed out from Firebase
‚úÖ Session cleared`;
        
        showResult(7, result);
        updateStatus(7, 'success', 'Logged Out');
      } catch (error) {
        showResult(7, `<span class="error-text">‚ùå ${error.message}</span>`, true);
        updateStatus(7, 'error', 'Failed');
      }
    };
  </script>
</body>
</html>
